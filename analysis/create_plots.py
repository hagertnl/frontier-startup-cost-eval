#!/usr/bin/env python3

# This script requires `benchmark_times.csv`, generated by `create_csv.sh`
# This script generates two files: scaling_warm_start.png and scaling_cold_start.png,
# which are figures that have 1 unique set of axes per benchmark

import matplotlib.pyplot as plt
import matplotlib.axes as mplax
from matplotlib.patches import Patch
import numpy as np
import os
import pandas as pd
import re

if not os.path.isfile('benchmark_times.csv'):
    print("Missing required input file benchmark_times.csv. Please run create_csv.sh first.")
    exit(1)

df = pd.read_csv('benchmark_times.csv')

# Classify as cold/warm runs
df['cache'] = df['iteration'].apply(lambda x: 'cold' if x == 1 else 'warm')

# Now, summarize cold/warm timings with avg & stdev
df_grouped = df.groupby(['benchmark', 'tool', 'nnodes', 'cache'])['seconds'].agg(['mean', 'std'])
print(df_grouped)
df_grouped = df_grouped.reset_index()

fig, axes = plt.subplots(1, 4, figsize=(20, 5))

# Custom legend
legend_colors = ["#0072B2", "#E69F00", "#56B4E9", "#009E73", "#D55E00"]
legend_labels = ['nfs-baseline', 'lustre-baseline', 'sbcast', 'spindle', 'copper']

legend_labels_to_index = {}
for i in range(0, len(legend_labels)):
    legend_labels_to_index[legend_labels[i]] = i

legend_handles = [Patch(color=color, label=label) for color, label in zip(legend_colors, legend_labels)]
legend_labels = [h.get_label() for h in legend_handles]
fig.legend(legend_handles, legend_labels, loc='upper center', bbox_to_anchor=(0.5, 0.1), ncol=5, frameon=False, fontsize=14)
fig.tight_layout(rect=[0.01, 0.1, 1, 0.95])

# Create a mapping of axis index to benchmark name
benchmark_to_ax_index = {}
cur_index = 0
# Assign benchmarks to axes
for b in df_grouped['benchmark'].unique():
    benchmark_to_ax_index[b] = cur_index
    cur_index += 1

for cache in ['cold', 'warm']:
    # Set labels, scales
    axes[0].set_ylabel("Time (s)", fontsize=14)
    for ax in axes:
        ax.set_xlabel("# Nodes", fontsize=14)
        ax.tick_params(axis='both', labelsize=12)
        ax.set_xscale('log')

    df = df_grouped[df_grouped['cache'] == cache]
    # For each unique benchmark/tool, get & plot data
    for index, entry in df[['benchmark', 'tool']].drop_duplicates().iterrows():
        single_series_df = df[(df['benchmark'] == entry['benchmark']) & (df['tool'] == entry['tool'])]
        nnodes = single_series_df['nnodes'].to_numpy()
        time_avg = single_series_df['mean'].to_numpy()
        time_stdev = single_series_df['std'].to_numpy()
        sorted_indices = nnodes.argsort()
        nnodes_sorted = nnodes[sorted_indices]
        time_avg_sorted = time_avg[sorted_indices]
        time_stdev_sorted = time_stdev[sorted_indices]
        axes[benchmark_to_ax_index[entry['benchmark']]].errorbar(nnodes_sorted, time_avg_sorted, yerr=time_stdev_sorted, fmt='-o', capsize=5, color=legend_colors[legend_labels_to_index[entry['tool']]])
        axes[benchmark_to_ax_index[entry['benchmark']]].set_title(entry['benchmark'], fontsize=16)

    plt.savefig(f'scaling_{cache}_start.png', dpi=100)

    # Clear data
    for ax in axes.flat:
        ax.clear()
